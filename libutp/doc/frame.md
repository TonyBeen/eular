# PATH_CHALLENGE 和 PATH_RESPONSE 帧详解

## 一、核心作用

```
┌─────────────────────────────────────────────────────────────────┐
│                       路径验证机制                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  PATH_CHALLENGE:  "这条路径通吗？请证明你能收到"                      │
│                                                                  │
│  PATH_RESPONSE:   "我收到了，这是你发的数据，证明路径是通的"           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 二、帧结构

```
PATH_CHALLENGE Frame (Type = 0x1a):
┌─────────────────────────────────────────────────────────────────┐
│  Type (0x1a)                                                     │
├─────────────────────────────────────────────────────────────────┤
│  Data (8 bytes)                                                  │
│  └── 随机生成的挑战数据                                          │
│      (必须是不可预测的)                                          │
└─────────────────────────────────────────────────────────────────┘

PATH_RESPONSE Frame (Type = 0x1b):
┌─────────────────────────────────────────────────────────────────┐
│  Type (0x1b)                                                     │
├─────────────────────────────────────────────────────────────────┤
│  Data (8 bytes)                                                  │
│  └── 原样复制 PATH_CHALLENGE 中的数据                            │
└─────────────────────────────────────────────────────────────────┘

★ 两个帧都很简单，只有8字节的数据字段
```

## 三、使用场景

### 3.1 连接迁移验证

```
┌─────────────────────────────────────────────────────────────────┐
│              场景：Client 从 WiFi 切换到 4G                      │
└─────────────────────────────────────────────────────────────────┘

Client (WiFi:  192.168.1.100)                          Server
   │                                                     │
   │◄──────────── 正常通信 ─────────────────────────────►│
   │                                                     │
   
   [Client 切换到 4G 网络，IP变为 10.0.0.50]
   
Client (4G: 10.0.0.50)                                Server
   │                                                     │
   │  从新地址发送包含数据的 Packet                       │
   │──────────────────────────────────────────────────►  │
   │                                                     │
   │                         [Server 收到来自新地址的包] │
   │                         [需要验证这是真的Client]     │
   │                                                     │
   │      PATH_CHALLENGE { Data: 0xAABBCCDD11223344 }    │
   │  ◄───────────────────────────────────────────────── │
   │                   (发送到新地址 10.0.0.50)          │
   │                                                     │
   │      PATH_RESPONSE { Data: 0xAABBCCDD11223344 }     │
   │  ──────────────────────────────────────────────────►│
   │                                                     │
   │                         [验证成功！路径已确认]       │
   │                         [可以在新路径上发送数据]      │
   │                                                     │
   │◄─────────── 继续正常通信（使用新路径）─────────────►│
   │                                                     │
```

### 3.2 NAT Rebinding 验证

```
┌─────────────────────────────────────────────────────────────────┐
│              场景：NAT 映射改变                                  │
└─────────────────────────────────────────────────────────────────┘

Client ──► NAT (旧映射:  1.2.3.4:5000) ──► Server
              │
              ▼  [NAT映射超时，重新分配]
              
Client ──► NAT (新映射: 1.2.3.4:6000) ──► Server
                                              │
                                              ▼
                              [Server 看到源端口变了]
                              [发送 PATH_CHALLENGE 验证]
```

### 3.3 主动路径探测

```
┌─────────────────────────────────────────────────────────────────┐
│              场景：探测备用路径是否可用                          │
└─────────────────────────────────────────────────────────────────┘

Client (有两个网卡)                                   Server
   │                                                     │
   │  主路径 (eth0: 192.168.1.100)  正常通信             │
   │◄───────────────────────────────────────────────────►│
   │                                                     │
   │  [想测试备用网卡是否也能到达Server]                  │
   │                                                     │
   │  PATH_CHALLENGE { Data: 0x1234...  }                  │
   │  (从 eth1:  10.0.0.50 发送)                          │
   │──────────────────────────────────────────────────►  │
   │                                                     │
   │  PATH_RESPONSE { Data: 0x1234... }                   │
   │  ◄───────────────────────────────────────────────── │
   │                                                     │
   │  [备用路径可用！可作为故障转移备选]                  │
   │                                                     │
```

## 四、为什么需要路径验证？

```
┌─────────────────────────────────────────────────────────────────┐
│                      安全考虑                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  防止放大攻击：                                                  │
│                                                                  │
│  攻击者                     Server                  受害者       │
│     │                          │                      │         │
│     │  伪造源地址为受害者IP     │                      │         │
│     │  假装迁移到受害者地址     │                      │         │
│     │─────────────────────────►│                      │         │
│     │                          │                      │         │
│     │                          │  如果不验证，         │         │
│     │                          │  Server会向受害者    │         │
│     │                          │  发送大量数据        │         │
│     │                          │─────────────────────►│ ✗ 攻击  │
│     │                          │                      │         │
│                                                                  │
│  有了路径验证：                                                  │
│                                                                  │
│  攻击者                     Server                  受害者       │
│     │                          │                      │         │
│     │  伪造源地址               │                      │         │
│     │─────────────────────────►│                      │         │
│     │                          │                      │         │
│     │                          │  PATH_CHALLENGE      │         │
│     │                          │─────────────────────►│         │
│     │                          │                      │         │
│     │                          │  受害者不知道如何响应 │         │
│     │                          │  (没有正确的Data)    │         │
│     │                          │                      │         │
│     │                          │  验证失败，不发数据  │ ✓ 安全  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 五、验证流程详解

```
┌─────────────────────────────────────────────────────────────────┐
│                    完整验证流程                                  │
└─────────────────────────────────────────────────────────────────┘

发起方                                               响应方
   │                                                   │
   │  1. 生成随机8字节 challenge_data                  │
   │                                                   │
   │  2. 发送 PATH_CHALLENGE                           │
   │     同时启动定时器                                │
   │─────────────────────────────────────────────────►│
   │                                                   │
   │                          3. 收到 PATH_CHALLENGE   │
   │                             提取 Data             │
   │                                                   │
   │                          4. 立即发送 PATH_RESPONSE│
   │                             复制相同的 Data       │
   │◄─────────────────────────────────────────────────│
   │                                                   │
   │  5. 收到 PATH_RESPONSE                            │
   │     检查 Data 是否匹配                            │
   │                                                   │
   │  匹配？                                           │
   │  ├── YES → 路径验证成功                           │
   │  └── NO  → 忽略（可能是攻击或乱序）               │
   │                                                   │
   
   如果定时器超时没收到响应：
   ├── 重试（最多几次）
   └── 放弃，路径不可用
```

## 六、与连接迁移的配合

```
┌─────────────────────────────────────────────────────────────────┐
│                 连接迁移的完整过程                               │
└─────────────────────────────────────────────────────────────────┘

Client                                                Server
   │                                                     │
   │  ① 从新地址发送数据（触发迁移）                      │
   │  使用新的 Connection ID                             │
   │──────────────────────────────────────────────────►  │
   │                                                     │
   │                              ② Server检测到新地址   │
   │                                                     │
   │  ③ PATH_CHALLENGE（验证新路径）                     │
   │  ◄───────────────────────────────────────────────── │
   │                                                     │
   │  ④ PATH_RESPONSE                                    │
   │  ──────────────────────────────────────────────────►│
   │                                                     │
   │                              ⑤ 验证成功             │
   │                                                     │
   │  ⑥ 正常通信（使用新路径）                           │
   │  ◄─────────────────────────────────────────────────►│
   │                                                     │
   │  ⑦ RETIRE_CONNECTION_ID（废弃旧CID）               │
   │  ──────────────────────────────────────────────────►│
   │                                                     │
```

## 七、特殊规则

```
┌─────────────────────────────────────────────────────────────────┐
│                      重要规则                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. PATH_RESPONSE 必须在收到 PATH_CHALLENGE 的同一路径发送       │
│     └── 不能用其他路径回复                                       │
│                                                                  │
│  2. 在路径验证完成前，限制发送数据量                             │
│     └── 防止被利用进行放大攻击                                   │
│     └── 通常限制为3倍收到的数据量                                │
│                                                                  │
│  3. PATH_RESPONSE 应该尽快发送                                   │
│     └── 可以和其他帧一起放在同一个包里                          │
│                                                                  │
│  4. 同时可以有多个 PATH_CHALLENGE 在途                           │
│     └── 通过 Data 字段区分                                      │
│                                                                  │
│  5. 收到不认识的 PATH_RESPONSE 应该忽略                          │
│     └── 可能是已超时的挑战的迟到响应                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 八、lsquic 实现

```c
// 发送 PATH_CHALLENGE
static void
generate_path_challenge_frame (struct ietf_full_conn *conn,
                               struct conn_path *path)
{
    // 生成8字节随机数据
    RAND_bytes(path->cop_path_challenge, 8);
    
    // 记录挑战数据，用于匹配响应
    path->cop_n_chals++;
    
    // 生成帧
    pf->pf_gen_path_challenge_frame(
        packet_out->po_data + packet_out->po_data_sz,
        path->cop_path_challenge);
    
    // 启动定时器
    lsquic_alarmset_set(&conn->ifc_alset, AL_PATH_CHAL,
                        now + calc_path_challenge_timeout());
}

// 处理收到的 PATH_CHALLENGE
static int
process_path_challenge_frame (struct ietf_full_conn *conn,
                              const unsigned char *data)
{
    // 立即安排发送 PATH_RESPONSE
    // 使用相同的8字节数据
    memcpy(conn->ifc_path_response, data, 8);
    conn->ifc_send_flags |= SF_SEND_PATH_RESP;
    
    return 0;
}

// 处理收到的 PATH_RESPONSE
static int
process_path_response_frame (struct ietf_full_conn *conn,
                             struct conn_path *path,
                             const unsigned char *data)
{
    // 检查是否匹配我们发出的挑战
    if (memcmp(data, path->cop_path_challenge, 8) == 0) {
        // 匹配！路径验证成功
        path->cop_flags |= COP_VALIDATED;
        LSQ_DEBUG("path validated");
        return 0;
    }
    
    // 不匹配，忽略
    return 0;
}
```

## 九、包的填充要求

```
┌─────────────────────────────────────────────────────────────────┐
│              路径验证包的 PADDING 要求                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  包含 PATH_CHALLENGE 的包应该填充到至少 1200 字节                │
│                                                                  │
│  原因：                                                          │
│  ① 验证路径是否支持最小 QUIC 包大小 (1200 bytes)                 │
│  ② 同时作为 MTU 探测                                            │
│                                                                  │
│  Packet 结构示例：                                               │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  QUIC Header                                                ││
│  ├─────────────────────────────────────────────────────────────┤│
│  │  PATH_CHALLENGE Frame (9 bytes)                             ││
│  ├─────────────────────────────────────────────────────────────┤│
│  │  PADDING (填充到 1200 字节)                                 ││
│  ├─────────────────────────────────────────────────────────────┤│
│  │  Encryption Tag (16 bytes)                                  ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 十、总结

| 方面 | PATH_CHALLENGE (0x1a) | PATH_RESPONSE (0x1b) |
|------|----------------------|---------------------|
| **作用** | 发起路径验证 | 回应路径验证 |
| **数据** | 8字节随机数 | 复制challenge的8字节 |
| **发送时机** | 检测到新路径/需要验证 | 收到challenge后立即 |
| **发送路径** | 待验证的新路径 | 必须在同一路径回复 |
| **超时处理** | 可重试若干次 | 无超时概念 |
| **安全作用** | 防止地址欺骗和放大攻击 | 证明路径可达性 |

**核心目的：确保对端确实在那个地址上，防止攻击者通过伪造源地址让Server向受害者发送大量数据。**