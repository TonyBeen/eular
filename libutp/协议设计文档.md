# 基于UDP的传输协议 (UTP - UDP Based Transport Protocol)

---

## 1.1 协议头部设计

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         SCID(32 bits)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         DCID(32 bits)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Packet Number(64bits)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Packet Number(64bits)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Payload Length        |     Types     |    reserve    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           Frames...                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 头部字段说明 (固定 20 字节)

| 字段 | 大小 | 描述 |
|------|------|------|
| **SCID** | 4 字节 | Source Connection ID |
| **DCID** | 4 字节 | Destination Connection ID |
| **Packet Number** | 8 字节 | 单调递增的包序号 |
| **Payload Length** | 2 字节 | 负载长度(不包含头部) |
| **Types** | 1 字节 | 包类型 |
| **Reserve** | 1 字节 | 保留 |

---

## 1.2 Types 字段定义 (1 字节)

| 值 | 名称 | 描述 | TODO |
|-------|-------|-------|-----------|
| 0x01 | Initial | ClientHello 建连标志, 携带Version帧, 如果用户选择加密则携带Crypto帧 | None |
| 0x02 | Handshake | ServerHello 携带确认信息 | 0-RTT同样响应, 同时携带kFrameSessionToken帧更新会话密钥 |
| 0x03 | 0-RTT | 向服务重新发送数据, 如切换网络等. 携带会话票据密钥 | 需要在保活时间内完成, 否则服务器销毁资源需要重新建立连接 |
| 0x04 | ConnectionClose | 相对端发送ConnectionClose帧 | 对端响应 ConnectionClose 并等待 3 * PTO, 超时后销毁资源 |

---

### 2.1 控制帧类型

| Frame Type | 名称 | 描述 |
|------------|------|------|
| 0x01 | Stream | 流 |
| 0x02 | Ack | 确认帧 |
| 0x03 | Padding | 填充帧 |
| 0x04 | ResetStream | 流重置帧 |
| 0x05 | ConnectionClose | 连接关闭帧 |
| 0x06 | Blocked | 连接级阻塞帧 |
| 0x07 | treamBlocked | 流级阻塞帧 |
| 0x08 | Ping | 心跳帧 |
| 0x09 | MaxData | 连接级最大数据帧 |
| 0x0A | MaxStreamData | 流级最大数据帧 |
| 0x0B | MaxStreams | 最大流数帧 |
| 0x0C | PathChallenge | 路径校验帧 |
| 0x0D | PathResponse | 路径响应帧 |
| 0x0E | Crypto | 加密数据帧 |
| 0x0F | SessionToken | 会话票据帧 |
| 0x10 | AckFrequency | 确认频率帧 |
| 0x11 | Version | 版本协商帧 |

---

### 3.1 Stream帧
```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| type(8 bits)  |  flag(8 bits) |         id(16 bits)           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         offset(64 bits)                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       length (16 bits)        |                  data         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

struct {
    uint8_t         frame_type;
    uint8_t         stream_flag;
    uint16_t        stream_id;
    uint64_t        stream_offset;
    uint16_t        stream_date_length;
    const uint8_t*  stream_data;
}
```
### 3.2 Ack帧
`重传时不重传Ack帧, 下一个包的Ack会携带上一个包Ack帧要确认的包号, 故`
```
struct AckRange {
    uint32_t    gap{0};
    uint32_t    length{0};
};

struct {
    uint8_t         frame_type;
    uint8_t         ack_count{0};
    uint16_t        ack_delay{0};
    uint64_t        ack_largest{0};
    uint64_t        first_ack_range;
    std::vector<AckRange>  ack_ranges;
}

// 场景: 接收端收到包号 95-100, 90-92, 80-85
// QUIC 由于存在变长编码, 所以在设计时进行减1处理, 在边界时节省1字节, 这样在连续确认时, 可以节省更多字节. 此处未采用变长编码, 故使用实际数值.
// 这样做的目的也是因为在发生丢包后重传新的PN, 旧序号丢弃, 故在确认机制上本就不连续, 比如丢失的86号包后续可能是101号包或更大.
// 包号状态:
//   80   81   82  83  84  85  86  87  88  89  90  91  92   93  94  95  96  97   98  99  100
//   ✓    ✓    ✓   ✓   ✓   ✓  ✗   ✗   ✗  ✗   ✓   ✓   ✓   ✗   ✗   ✓   ✓   ✓   ✓   ✓    ✓
//
// ACK 帧构造: 
//
//  Largest Acknowledged = 100
//
//  First ACK Range = 6
//  └── 确认 [95, 100] 共 6 个包
//
//  ACK Range Count = 2
//  └── 有 2 个额外的 ACK Range
//
//  ACK Range 1:
//  ├── Gap = 2
//  │   └── 未确认 [93, 94] 共 2 个包 (Gap)
//  └── ACK Range Length = 3
//      └── 确认 [90, 92] 共 3 个包 (Length)
//
//  ACK Range 2:
//  ├── Gap = 4
//  │   └── 未确认 [86, 89] 共 4 个包 (Gap)
//  └── ACK Range Length = 6
//      └── 确认 [80, 85] 共 6 个包 (Length)
//
```

### 3.3 Padding 帧
```
struct {
    uint8_t         frame_type;
    uint16_t        padding_length{0};
}
```

