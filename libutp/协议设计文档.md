# 轻量级可靠传输协议 (LRTP - Lightweight Reliable Transport Protocol)

---

## 1.1 协议头部设计

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         SCID(32 bits)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         DCID(32 bits)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Packet Number(64bits)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Packet Number(64bits)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Payload Length        |     flags     |    reserve    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           Checksum                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           Frames...                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 头部字段说明 (固定 28 字节)

| 字段 | 大小 | 描述 |
|------|------|------|
| **SCID** | 4 字节 | Source Connection ID |
| **DCID** | 4 字节 | Destination Connection ID |
| **Packet Number** | 8 字节 | 单调递增的包序号 |
| **Payload Length** | 2 字节 | 负载长度(不包含头部) |
| **Flags** | 1 字节 | 标志位 |
| **Reserve** | 1 字节 | 保留 |
| **Checksum** | 4 字节 | CRC32 校验和 |

---

## 1.2 Flags 字段定义 (1 字节)

```
 0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
|SYN|ACK|FIN|RST|ENC|RES|RES|RES|
+---+---+---+---+---+---+---+---+
```

| 位 | 名称 | 描述 |
|----|------|------|
| 0 | SYN | 建连标志, 携带Version帧, 如果用户选择加密则携带Crypto帧 |
| 1 | ACK | 携带确认信息 |
| 2 | FIN | 流结束标志 |
| 3 | RST | 重置连接/流 |
| 4 | ENC | 加密标志 |
| 5-7 | RES | 保留 |

---

## 2. 控制帧格式

当 Flags. TYPE = 01 (CTRL) 时，Payload 包含控制帧：

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Frame Type   |            Frame Data...                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 控制帧类型

| Frame Type | 名称 | 描述 |
|------------|------|------|
| 0x01 | ACK | 确认帧 |
| 0x02 | WINDOW_UPDATE | 流控窗口更新 |
| 0x03 | STREAM_CLOSE | 关闭流 |
| 0x04 | CONNECTION_CLOSE | 关闭连接 |
| 0x05 | PATH_CHALLENGE | 路径验证挑战 |
| 0x06 | PATH_RESPONSE | 路径验证响应 |
| 0x07 | MTU_PROBE | MTU探测 |
| 0x08 | MTU_ACK | MTU探测确认 |
| 0x09 | NEW_CONNECTION_ID | 新连接ID（用于迁移） |
| 0x0A | PING | 心跳 |
| 0x0B | PONG | 心跳响应 |

---

## 5. ACK 帧格式

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Type (0x01)  |   ACK Count   |        ACK Delay (us)         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Largest Acknowledged                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   First Range |          ACK Range Block 1...                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Gap 1                |         ACK Range Block 2...  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

使用 SACK (Selective ACK) 机制，支持乱序确认。

---

## 6. 连接建立握手 (简化为 1-RTT)

```
客户端                                          服务端
   |                                               |
   |--- HANDSHAKE [SYN, ConnID, Token] ----------->|
   |                                               |
   |<-- HANDSHAKE [SYN+ACK, ConnID, Token] --------|
   |                                               |
   |--- DATA/ACK --------------------------------->|
   |                                               |
```

### 握手帧格式

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Handshake Type|    Reserved   |      Initial Max Streams      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Initial Max Data                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        Initial Max Stream Data                |   Init MTU    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Token (可选, 64 bits)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

| Handshake Type | 描述 |
|----------------|------|
| 0x01 | SYN (客户端发起) |
| 0x02 | SYN-ACK (服务端响应) |
| 0x03 | RETRY (服务端要求重试+Token) |

---

## 7. MTU 黑洞探测机制

### 7.1 探测算法

```
初始 MTU: 1200 字节 (保守值)
最大 MTU:  1500 字节 (以太网) 或 9000 字节 (Jumbo Frame)
探测步长: 二分法

状态机: 
  SEARCHING -> 发送探测包
  PROBING   -> 等待 ACK
  BASE      -> 使用当前 MTU
```

### 7.2 MTU 探测帧格式

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Type (0x07)   |   Reserved    |         Probe Size            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Probe Sequence                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Padding (填充至目标大小)                 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 7.3 探测流程

```
1. 连接建立后，使用安全MTU (1200)
2. 空闲时发送探测包，尝试更大MTU
3. 收到MTU_ACK → 确认该MTU可用，继续探测更大
4. 超时3次 → MTU黑洞，回退到上次成功的MTU
5. 定期重新探测 (默认600秒)
```

---

## 8. BBRv1 拥塞控制

### 8.1 核心状态

```c
struct BBRState {
    uint64_t btl_bw;           // 瓶颈带宽估计
    uint64_t rt_prop;          // 最小RTT
    uint32_t pacing_rate;      // 发送速率
    uint32_t cwnd;             // 拥塞窗口
    uint8_t  state;            // 当前状态
    uint8_t  cycle_index;      // ProbeBW周期索引
    uint64_t probe_rtt_time;   // 上次ProbeRTT时间
};

// 状态枚举
enum BBRState {
    STARTUP,      // 启动阶段，快速探测带宽
    DRAIN,        // 排空队列
    PROBE_BW,     // 稳态带宽探测
    PROBE_RTT     // RTT探测
};
```

### 8.2 关键参数

| 参数 | 值 | 描述 |
|------|-----|------|
| STARTUP_GAIN | 2. 89 | 启动阶段增益 (2/ln2) |
| DRAIN_GAIN | 0.35 | 排空阶段增益 |
| PROBE_BW_GAINS | [1.25, 0.75, 1, 1, 1, 1, 1, 1] | 8周期增益 |
| PROBE_RTT_INTERVAL | 10秒 | RTT探测间隔 |
| MIN_RTT_EXPIRY | 10秒 | 最小RTT过期时间 |

### 8.3 状态转换

```
                    ┌──────────────────┐
                    │     STARTUP      │
                    │  (增益=2.89)     │
                    └────────┬─────────┘
                             │ 带宽不再增长
                             ▼
                    ┌──────────────────┐
                    │      DRAIN       │
                    │  (增益=0.35)     │
                    └────────┬─────────┘
                             │ inflight ≤ BDP
                             ▼
         ┌─────────┌──────────────────┐─────────┐
         │         │    PROBE_BW      │         │
         │         │ (8周期循环)       │         │
         │         └──────────────────┘         │
         │                  │                   │
         │                  │ 10秒未更新min_rtt │
         │                  ▼                   │
         │         ┌──────────────────┐         │
         └─────────│   PROBE_RTT      │─────────┘
                   │ (cwnd=4, 200ms)  │
                   └──────────────────┘
```

### 8.4 伪代码实现

```python
def bbr_on_ack(ack):
    # 更新RTT
    rtt_sample = now() - ack.sent_time
    if rtt_sample < rt_prop or rt_prop_expired():
        rt_prop = rtt_sample
    
    # 更新带宽估计
    delivered = ack.delivered - prior_delivered
    interval = ack.delivered_time - prior_delivered_time
    bw_sample = delivered / interval
    btl_bw = max(btl_bw, bw_sample)  # 使用滑动窗口最大值
    
    # 状态机处理
    if state == STARTUP: 
        if not bandwidth_growing():
            state = DRAIN
    elif state == DRAIN: 
        if inflight <= bdp():
            state = PROBE_BW
            cycle_index = 0
    elif state == PROBE_BW: 
        advance_cycle_phase()
        if should_probe_rtt():
            state = PROBE_RTT
            probe_rtt_time = now()
    elif state == PROBE_RTT: 
        if now() - probe_rtt_time >= 200ms:
            state = PROBE_BW
    
    # 设置发送速率和窗口
    pacing_rate = btl_bw * pacing_gain()
    cwnd = bdp() * cwnd_gain()

def bdp():
    return btl_bw * rt_prop

def pacing_gain():
    if state == STARTUP:  return 2.89
    if state == DRAIN:  return 0.35
    if state == PROBE_RTT: return 1.0
    return PROBE_BW_GAINS[cycle_index]
```

---

## 9. 流式传输机制

### 9.1 流管理

```
Stream ID: 0-255 (1字节，共256个流)
  - 0-127: 客户端发起的流
  - 128-255: 服务端发起的流
  - Stream 0: 保留用于控制消息

每个流独立维护:
  - 发送缓冲区
  - 接收缓冲区 (重组乱序数据)
  - 流级别流控窗口
  - 优先级 (0-3)
```

### 9.2 流控机制

```
连接级别流控:
  - 全局发送窗口
  - 全局接收窗口

流级别流控:
  - 每流发送窗口
  - 每流接收窗口
  - WINDOW_UPDATE 帧更新窗口
```

### 9.3 WINDOW_UPDATE 帧格式

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Type (0x02)   |   Stream ID   |        Reserved              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Window Increment                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

Stream ID = 0xFF 表示连接级别窗口更新。

---

## 10. 路径切换与快速重连

### 10.1 连接迁移机制

```
关键点:
1. Connection ID 不变，路径可变
2. 新路径需验证 (防止放大攻击)
3. 支持同时探测多路径
```

### 10.2 PATH_CHALLENGE / PATH_RESPONSE

```
PATH_CHALLENGE: 
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Type (0x05)   |                   Reserved                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                    Challenge Data (8 bytes)                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

PATH_RESPONSE: 
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Type (0x06)   |                   Reserved                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                    Response Data (8 bytes, 同Challenge)       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 10.3 路径切换流程 (WiFi → 4G)

```
时序:
                 旧路径(WiFi)              新路径(4G)
    客户端 ─────────────────────────────────────────── 服务端
       │                                                │
       │ ← ─ ─ ─ ─ WiFi断开检测 ─ ─ ─ ─ →               │
       │                                                │
       ├─────── PATH_CHALLENGE (4G) ──────────────────→│
       │                                                │
       │←────── PATH_RESPONSE ─────────────────────────┤
       │                                                │
       ├─────── DATA (继续传输) ───────────────────────→│
       │                                                │

触发条件: 
1. 收到 ICMP 不可达
2. 连续多次重传超时
3. 应用层检测到网络变化
4. 主动探测失败
```

### 10.4 NEW_CONNECTION_ID 帧

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Type (0x09)   |  Seq Number   |      Retire Prior To          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                  New Connection ID (8 bytes)                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

---

## 11. 其他简化与补充设计

### 11.1 重传机制

```
策略:  基于时间的重传 + 快速重传

超时重传 (RTO):
  RTO = SRTT + max(4*RTTVAR, 1ms)
  
快速重传: 
  收到3个重复ACK → 立即重传
  
尾部丢包探测 (TLP):
  最后一个包发送后 max(2*SRTT, 10ms) 未收到ACK → 发送探测
```

### 11.2 心跳保活

```
PING/PONG 帧:
 0       1       2       3
+-------+-------+-------+-------+
| 0x0A  |      Timestamp        |
+-------+-------+-------+-------+

+-------+-------+-------+-------+
| 0x0B  |      Timestamp        |
+-------+-------+-------+-------+

间隔:  默认30秒
超时: 3次无响应判定连接断开
```

### 11.3 连接关闭

```
优雅关闭:
1. 发送 CONNECTION_CLOSE 帧
2. 等待对端 ACK
3. 进入 TIME_WAIT (2*MSL)

立即关闭: 
1. 发送带 RST 标志的包
2. 立即释放资源
```

### 11.4 错误码定义

| 错误码 | 名称 | 描述 |
|--------|------|------|
| 0x00 | NO_ERROR | 正常关闭 |
| 0x01 | INTERNAL_ERROR | 内部错误 |
| 0x02 | FLOW_CONTROL_ERROR | 流控错误 |
| 0x03 | STREAM_LIMIT_ERROR | 流数量超限 |
| 0x04 | STREAM_STATE_ERROR | 流状态错误 |
| 0x05 | PROTOCOL_VIOLATION | 协议违规 |
| 0x06 | INVALID_PACKET | 无效数据包 |
| 0x07 | PATH_VALIDATION_FAILED | 路径验证失败 |

---

## 12. 完整数据包示例

### 12.1 数据包 (携带ACK)

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Version=0x01  | Flags=0x04    |       Packet Length=100       |
|               | (DATA+ACK)    |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Connection ID (高32位)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Connection ID (低32位)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Packet Number = 42                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Stream ID=1   | Stream Flags  |        Stream Offset          |
|               | =0x00         |        (高16位)               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Stream Offset (低16位)       |    Payload Length = 64        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         CRC32 Checksum                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        ACK Frame...                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        User Payload (64 bytes)                |
|                              ...                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

---

## 13. 默认参数配置

```yaml
Connection:
  initial_mtu: 1200
  max_mtu: 1500
  max_streams: 256
  idle_timeout: 30s
  handshake_timeout:  10s

Flow Control:
  initial_max_data: 1MB
  initial_max_stream_data: 256KB
  max_receive_buffer: 16MB

BBR: 
  min_cwnd: 4 packets
  probe_rtt_duration: 200ms
  bw_window_size: 10 RTTs
  rtt_window_size: 10s

Retransmission: 
  initial_rto: 1000ms
  min_rto: 10ms
  max_rto: 60s
  max_retries: 10

MTU Probe:
  probe_interval: 600s
  max_probe_attempts: 3
```

---

## 14. 协议栈示意

```
┌─────────────────────────────────────────┐
│            Application Layer            │
│      (用户自行加密数据在此处理)           │
├─────────────────────────────────────────┤
│              Stream Layer               │
│    (多路复用, 流控, 优先级, 重组)         │
├─────────────────────────────────────────┤
│            Connection Layer             │
│   (连接管理, 路径迁移, 拥塞控制BBRv1)     │
├─────────────────────────────────────────┤
│             Packet Layer                │
│   (封包/解包, ACK, 重传, MTU探测)         │
├─────────────────────────────────────────┤
│                UDP                      │
└─────────────────────────────────────────┘
```

---
